{% extends 'base.html' %}

{% load crispy_forms_tags %}

{% block heading %}
    <h3><span class="fa fa-th"></span> Dashboard</h3>
{% endblock %}

{% block content %}
    <div class="container">
    {% if sticky_message %}
        <div class="alert alert-info alert-dismissable">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
            {{ sticky_message.message|safe }}
        </div>
    {% endif %}

    <div class="row">
        {# TODO add Bitcoin chart #}
        <div class="col-sm-4 col-md-4">
            <div id="bitcoinChart" class="panel-body"></div>
        </div>

        {# TODO add Ethereum chart #}
        <div class="col-sm-4 col-md-4">
            <div id="ethereumChart" class="panel-body"></div>
        </div>

        {# TODO add Litecoin chart #}
        <div class="col-sm-4 col-md-4">
            <div id="litecoinChart" class="panel-body"></div>
        </div>
    </div> <!-- end row -->

    <div class="row">
        <div class="col-sm-6 col-md-6">
            <div class="row">
                <div class="col-sm-12 col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h5 class="panel-title text-center">
                                <b>Cerebro's Analysis</b>
                            </h5>
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="panel panel-default">
                                    <li><a href="{% url 'dashboard' %}">
                                        <span class="fa fa-th"></span>&nbsp;Dashboard</a>
                                    </li>
                                </div>
                            </div>
                            <div class="row">
                                <div class="panel panel-default">
                                    <li><a href="{% url 'dashboard' %}">
                                        <span class="fa fa-th"></span>&nbsp;Dashboard</a>
                                    </li>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- end row -->

                <div class="row">
                    <div class="col-sm-12 col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title text-center">
                                    <b>14-Day Breakdown</b>
                                </h3>
                            </div>
                            <table class="table table-condensed">
                                <tr>
                                    <td><b>Lows</b></td>
                                    <td id="id_lows"></td>
                                    <td><b>Lowest</b></td>
                                    <td id="id_lowest" align="right"></td>
                                </tr>
                                <tr>
                                    <td><b>Highs</b></td>
                                    <td id="id_highs"></td>
                                    <td><b>Highest</b></td>
                                    <td id="id_highest" align="right"></td>
                                </tr>
                                <tr>
                                    <td><b>Within Target</b></td>
                                    <td id="id_within_target"></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td><b>Other</b></td>
                                    <td id="id_other"></td>
                                    <td><b>Average</b></td>
                                    <td id="id_average" align="right"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div> <!-- end row -->
            </div> <!-- end col -->

            <div class="col-sm-6 col-md-6">
                <div class="panel panel-default">
                    <div id="chart_panel" class="panel-body" style="width:100%;height:343px"></div>
                </div>
            </div> <!--end col -->

        </div> <!-- end row -->
    </div>

    <div class="container">
        <div class="row">
            <div class="col-sm-12 col-md-12">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <table id="glucose_table" class="display responsive" width="100%">
                            <thead>
                            <tr>
                                <th class="all">
                                    <center>Value</center>
                                </th>
                                <th class="all">Category</th>
                                <th class="min-tablet">Date</th>
                                <th class="min-tablet">Time</th>
                                <th class="min-desktop">Notes</th>
                                <th class="min-desktop">Tags</th>
                                <th class="all"></th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extracss %}
    <link href="{{ STATIC_URL }}datatables/media/css/jquery.dataTables.css" rel="stylesheet">
    <link href="{{ STATIC_URL }}datatables/extensions/Responsive/css/dataTables.responsive.css" rel="stylesheet">
    <link href="{{ STATIC_URL }}datatables/extensions/TableTools/css/dataTables.tableTools.css" rel="stylesheet">
{% endblock %}

{% block extrajs %}
    <script src="{{ STATIC_URL }}datatables/media/js/jquery.dataTables.js"></script>
    <script src="{{ STATIC_URL }}datatables/extensions/Responsive/js/dataTables.responsive.js"></script>
    <script src="{{ STATIC_URL }}datatables/extensions/TableTools/js/dataTables.tableTools.js"></script>
    <script src="{{ STATIC_URL }}highcharts/js/highcharts.js"></script>
    <script src="{{ STATIC_URL }}highcharts/js/modules/exporting.js"></script>
    <script src="{{ STATIC_URL }}scripts/scripts.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#id_hba1c_panel').tooltip();

            // Update stats in panels
            var statsUrl = "{% url 'stats_json' %}";

            function loadStats() {
                $.getJSON(statsUrl,
                    function (data) {
                        document.getElementById('id_latest_entry').innerHTML =
                            data['stats']['latest_entry']['value'];
                        document.getElementById('id_latest_entry').className =
                            "text-center " + data['stats']['latest_entry']['css_class'];

                        document.getElementById('id_hba1c').innerHTML =
                            data['stats']['hba1c']['value'];
                        document.getElementById('id_hba1c').className =
                            "text-center " + data['stats']['hba1c']['css_class'];

                        /*document.getElementById('id_num_records').innerHTML =
                            data['stats']['num_records'];*/

                        document.getElementById('id_lowest').innerHTML =
                            data['stats']['breakdown']['lowest']['value'];
                        document.getElementById('id_lowest').className =
                            data['stats']['breakdown']['lowest']['css_class'];

                        document.getElementById('id_highest').innerHTML =
                            data['stats']['breakdown']['highest']['value'];
                        document.getElementById('id_highest').className =
                            data['stats']['breakdown']['highest']['css_class'];

                        document.getElementById('id_average').innerHTML =
                            data['stats']['breakdown']['average']['value'];
                        document.getElementById('id_average').className =
                            data['stats']['breakdown']['average']['css_class'];

                        document.getElementById('id_highs').innerHTML =
                            data['stats']['breakdown']['highs'];
                        document.getElementById('id_lows').innerHTML =
                            data['stats']['breakdown']['lows'];
                        document.getElementById('id_within_target').innerHTML =
                            data['stats']['breakdown']['within_target'];
                        document.getElementById('id_other').innerHTML =
                            data['stats']['breakdown']['other'];

                        var twitter_text = "#bgnow "
                            + data['stats']['latest_entry']['value']
                            + " (" + data['stats']['latest_entry']['record_time']
                            + ") " + data['stats']['latest_entry']['notes'];
                        // Remove leading and trailing spaces
                        twitter_text = twitter_text.trim();
                        updateTwitterValues(twitter_text, 'glucosetracker');
                    }
                )
            };

            loadStats();


            // Glucose Average by Day chart
            var bitcoinChartOptions = {
                credits: {enabled: false},
                chart: {
                    renderTo: 'bitcoinChart', // name of the <div id="avgByDayPanel" this'll push to
                    type: 'line',
                },
                legend: {enabled: false},
                title: {text: 'Bitcoin Chart'},
                subtitle: {text: 'Last 14 Days'},
                xAxis: {title: {text: null}, labels: {rotation: -45}},
                yAxis: {title: {text: null}},
                series: [{
                    animation: false
                }],
            };

            // Glucose Average by Day chart
            var ethereumChartOptions = {
                credits: {enabled: false},
                chart: {
                    renderTo: 'ethereumChart', // name of the <div id="avgByDayPanel" this'll push to
                    type: 'line',
                },
                legend: {enabled: false},
                title: {text: 'Average Glucose by Day'},
                subtitle: {text: 'Last 14 Days'},
                xAxis: {title: {text: null}, labels: {rotation: -45}},
                yAxis: {title: {text: null}},
                series: [{
                    animation: false
                }],
            };

            // Glucose Average by Day chart
            var litecoinChartOptions = {
                credits: {enabled: false},
                chart: {
                    renderTo: 'litecoinChart', // name of the <div id="avgByDayPanel" this'll push to
                    type: 'line',
                },
                legend: {enabled: false},
                title: {text: 'Litecoin Chart'},
                subtitle: {text: 'Last 14 Days'},
                xAxis: {title: {text: null}, labels: {rotation: -45}},
                yAxis: {title: {text: null}},
                series: [{
                    animation: false
                }],
            };

            var chartDataUrl = "{% url 'chart_data_json' %}?name=avg_by_day&days=14";

            function loadBitcoinChart() {
                $.getJSON(chartDataUrl,
                    function (data) {
                        bitcoinChartOptions.xAxis.categories = data['chart_data']['dates'];
                        bitcoinChartOptions.series[0].name = 'Avg Glucose ({{ user.settings.glucose_unit }})';
                        bitcoinChartOptions.series[0].data = data['chart_data']['values'];
                        var chart = new Highcharts.Chart(bitcoinChartOptions);
                    });
            }

            function loadEthereumChart() {
                $.getJSON(chartDataUrl,
                    function (data) {
                        ethereumChartOptions.xAxis.categories = data['chart_data']['dates'];
                        ethereumChartOptions.series[0].name = 'Avg Glucose ({{ user.settings.glucose_unit }})';
                        ethereumChartOptions.series[0].data = data['chart_data']['values'];
                        var chart = new Highcharts.Chart(ethereumChartOptions);
                    });
            }

            function loadLitecoinChart() {
                $.getJSON(chartDataUrl,
                    function (data) {
                        litecoinChartOptions.xAxis.categories = data['chart_data']['dates'];
                        litecoinChartOptions.series[0].name = 'Avg Glucose ({{ user.settings.glucose_unit }})';
                        litecoinChartOptions.series[0].data = data['chart_data']['values'];
                        var chart = new Highcharts.Chart(litecoinChartOptions);
                    });
            }

            loadBitcoinChart();
            loadEthereumChart();
            loadLitecoinChart();


            var oTable = $('#glucose_table').dataTable({
                "sDom": 'T<"container">lfrtip',
                "tableTools": {
                    "sSwfPath": "{{ STATIC_URL }}datatables/extensions/TableTools/swf/copy_csv_xls_pdf.swf",
                    "aButtons": ["csv", "pdf"]
                },
                "aLengthMenu": [
                    [10, 15, 25, 50, 75, 100],
                    [10, 15, 25, 50, 75, 100],
                ],
                "bProcessing": true,
                "bServerSide": true,
                "sAjaxSource": "{% url 'glucose_list_json' %}",
                "aaSorting": [[2, 'desc'], [3, 'desc']],

                // Disable sorting for the Tags and Delete columns.
                "aoColumnDefs": [{"bSortable": false, "aTargets": [5, 6]}]
            });

            // Add the glucose value and refresh the table data
            var frm = $('#quick_add_form');
            frm.submit(function () {
                $.ajax({
                    type: frm.attr('method'),
                    url: "{% url 'glucose_quick_add' %}",
                    data: frm.serialize(),
                    success: function (data) {
                        var message = jQuery.parseJSON(data);
                        if (message['success']) {
                            // Reload the table data. This function is located in
                            // scripts/scripts.js.
                            oTable.fnReloadAjax();

                            // Reload the chart and stats panels
                            loadStats();
                            loadChart();

                            document.getElementById('quick_add_form').reset();
                            $('#id_value').focus();

                            // Re-enable the submit button.
                            $('#submit-id-submit').prop('disabled', false);
                        }
                        else {
                            alert(message['error']);
                            $('#id_value').focus().select();

                            // Re-enable the submit button.
                            $('#submit-id-submit').prop('disabled', false);
                        }
                    },
                    error: function (data) {
                        alert('Sorry, something went wrong. Please try again.');
                    }
                });
                return false;
            });

            // For Twitter button
            {# TODO remove twitter button#}

            function updateTwitterValues(text, via) {
                $('#id_twitter_button').html('<a href="https://twitter.com/share?url=/" class="twitter-share-button" data-dnt="true" data-text="' + text + '" data-count="none" data-via="' + via + '">Tweet</a>');
                twttr.widgets.load();
            }

            !function (d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];

                if (!d.getElementById(id)) {
                    js = d.createElement(s);
                    js.id = id;
                    js.src = "https://platform.twitter.com/widgets.js";
                    fjs.parentNode.insertBefore(js, fjs);
                }
            }

            (document, "script", "twitter-wjs");
        });
    </script>
{% endblock %}